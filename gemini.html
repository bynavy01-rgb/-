<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì œì´ë‹˜ì˜ ìœ íŠœë¸Œ ë¶„ì„ê¸° Ver 3.0 (í‚¤ì›Œë“œ ì¶”ì¶œíƒ‘ì¬)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #4F46E5; --bg: #F3F4F6; --card: #FFFFFF; --text: #1F2937; --border: #E5E7EB; }
        [data-theme="dark"] { --primary: #818CF8; --bg: #111827; --card: #1F2937; --text: #F9FAFB; --border: #374151; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Malgun Gothic', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 20px; transition: all 0.3s; }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* í—¤ë” & ì¹´ë“œ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* ì…ë ¥ & í•„í„° */
        .input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .input-row input { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); }
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; }
        select { padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); width: 100%; }

        /* ë²„íŠ¼ë“¤ */
        button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-search { background: var(--primary); width: 100%; margin-top: 15px; padding: 15px; font-size: 16px; }
        .btn-search:hover { opacity: 0.9; }
        .btn-sub { background: #10B981; font-size: 13px; padding: 8px 15px; margin-left: 10px; }
        .theme-btn { background: var(--text); color: var(--bg); }
        .btn-thumb { background: #EF4444; font-size: 11px; padding: 4px 8px; margin-top: 4px; display: inline-block; text-decoration: none; color: white; border-radius: 4px; }

        /* ğŸ”¥ í‚¤ì›Œë“œ ë¶„ì„ ì˜ì—­ (NEW) */
        .keyword-box { background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #818CF8; display: none; }
        [data-theme="dark"] .keyword-box { background: #1e1b4b; border-color: #4338ca; }
        .keyword-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .keyword-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .hot-keyword { background: white; color: var(--primary); padding: 8px 15px; border-radius: 20px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 14px; border: 1px solid var(--primary); }
        .hot-keyword span { color: #EF4444; font-size: 12px; margin-left: 5px; }

        /* í…Œì´ë¸” */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; font-size: 13px; }
        th { background: var(--bg); padding: 12px; text-align: left; border-bottom: 2px solid var(--border); white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid var(--border); vertical-align: top; }
        .thumb-img { width: 120px; height: 68px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border); }
        .tag { display: inline-block; background: var(--bg); color: var(--primary); padding: 2px 6px; border-radius: 4px; font-size: 11px; margin: 2px; }
        .loader { text-align: center; padding: 40px; color: var(--primary); display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fab fa-youtube"></i> ì œì´ì˜ ë¶„ì„ê¸° Ver 3.0</h1>
        <button class="theme-btn" onclick="toggleTheme()"><i class="fas fa-adjust"></i> í…Œë§ˆ ë³€ê²½</button>
    </header>

    <div class="card">
        <div class="input-row">
            <input type="password" id="apiKey" placeholder="ğŸ”‘ YouTube API í‚¤ ì…ë ¥">
        </div>
        <div class="input-row">
            <input type="text" id="keyword" placeholder="ğŸ” ê²€ìƒ‰ì–´ (ì˜ˆ: ë¶í•œêµ° íŒŒë³‘, íƒˆë¶ë¯¼ ì°)" onkeypress="if(event.key==='Enter') search()">
        </div>
        <div class="filters">
            <select id="dateFilter">
                <option value="today">ğŸ“… ì˜¤ëŠ˜ (24ì‹œê°„)</option>
                <option value="week">ğŸ“… ì´ë²ˆ ì£¼ (7ì¼)</option>
                <option value="2weeks">ğŸ“… ìµœê·¼ 2ì£¼ (14ì¼)</option>
                <option value="month">ğŸ“… ìµœê·¼ 1ë‹¬ (30ì¼)</option>
                <option value="any">ğŸ“… ì „ì²´ ê¸°ê°„</option>
            </select>
            <select id="durationFilter">
                <option value="medium" selected>â±ï¸ 4~20ë¶„ (ì¼ë°˜)</option>
                <option value="long">â±ï¸ 20ë¶„ ì´ìƒ (ë¡±í¼)</option>
                <option value="short">â±ï¸ 4ë¶„ ë¯¸ë§Œ (ìˆí¼)</option>
            </select>
            <select id="sortFilter">
                <option value="viewCount">ğŸ”¥ ì¡°íšŒìˆ˜ìˆœ</option>
                <option value="date">ğŸ†• ìµœì‹ ìˆœ</option>
                <option value="relevance">ğŸ¯ ê´€ë ¨ì„±ìˆœ</option>
            </select>
            <select id="maxResults">
                <option value="10">10ê°œ ë¶„ì„</option>
                <option value="20" selected>20ê°œ ë¶„ì„</option>
                <option value="30">30ê°œ ë¶„ì„</option>
                <option value="50">50ê°œ ë¶„ì„</option>
            </select>
        </div>
        <button class="btn-search" onclick="search()">ğŸš€ ë¶„ì„ ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="keywordArea" class="keyword-box">
        <div class="keyword-header">
            <h3 style="color:#4F46E5"><i class="fas fa-fire"></i> ê²€ìƒ‰ëœ ì˜ìƒë“¤ì˜ í•µì‹¬ í‚¤ì›Œë“œ TOP 10</h3>
            <button class="btn-sub" onclick="copyKeywords()"><i class="fas fa-copy"></i> í‚¤ì›Œë“œ ë³µì‚¬</button>
        </div>
        <div id="keywordList" class="keyword-list">
            </div>
        <p style="margin-top:10px; font-size:12px; color:#666;">* ì´ ë‹¨ì–´ë“¤ì„ ì œëª©ì´ë‚˜ ì„¤ëª…ë€ì— ì¡°í•©í•´ì„œ ì‚¬ìš©í•´ë³´ì„¸ìš”!</p>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3>ğŸ“Š ìƒì„¸ ë°ì´í„°</h3>
            <button class="btn-sub" onclick="downloadCSV()"><i class="fas fa-file-excel"></i> ì—‘ì…€ ì €ì¥</button>
        </div>
        <div id="loader" class="loader"><i class="fas fa-spinner fa-spin fa-2x"></i><br><br>ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>
        <div class="table-wrap">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th width="140">ì¸ë„¤ì¼</th>
                        <th>ì œëª©</th>
                        <th width="120">ì±„ë„</th>
                        <th width="100">ì—…ë¡œë“œ</th>
                        <th width="80">êµ¬ë…ì</th>
                        <th width="90">ì¡°íšŒìˆ˜</th>
                        <th width="80">ê¸¸ì´</th>
                        <th width="80">ë°˜ì‘ë„</th>
                        <th>í•´ì‹œíƒœê·¸</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const savedKey = localStorage.getItem('yt_api_key_v3');
    if(savedKey) document.getElementById('apiKey').value = savedKey;
    
    let currentData = [];
    let topKeywords = [];

    async function search() {
        const apiKey = document.getElementById('apiKey').value;
        const keyword = document.getElementById('keyword').value;
        const max = document.getElementById('maxResults').value;
        
        if(!apiKey || !keyword) return alert('API í‚¤ì™€ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        localStorage.setItem('yt_api_key_v3', apiKey);

        document.getElementById('loader').style.display = 'block';
        document.getElementById('tableBody').innerHTML = '';
        document.getElementById('keywordArea').style.display = 'none';

        try {
            // 1. ê²€ìƒ‰ API
            let searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(keyword)}&type=video&maxResults=${max}&order=${document.getElementById('sortFilter').value}&videoDuration=${document.getElementById('durationFilter').value}&key=${apiKey}`;
            
            // ë‚ ì§œ í•„í„° (anyê°€ ì•„ë‹ ë•Œë§Œ ì ìš©)
            const dateVal = document.getElementById('dateFilter').value;
            if(dateVal !== 'any') {
                let d = new Date();
                d.setHours(0,0,0,0);
                if(dateVal === 'today') d.setDate(d.getDate()-1);
                else if(dateVal === 'week') d.setDate(d.getDate()-7);
                else if(dateVal === '2weeks') d.setDate(d.getDate()-14);
                else if(dateVal === 'month') d.setMonth(d.getMonth()-1);
                searchUrl += `&publishedAfter=${d.toISOString()}`;
            }

            const searchRes = await fetch(searchUrl);
            const searchData = await searchRes.json();
            if(!searchData.items?.length) throw new Error('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');

            // 2. ìƒì„¸ ì •ë³´ API
            const videoIds = searchData.items.map(i => i.id.videoId).join(',');
            const videoRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoIds}&key=${apiKey}`);
            const videoData = await videoRes.json();

            // 3. ì±„ë„ ì •ë³´ API
            const channelIds = [...new Set(videoData.items.map(v => v.snippet.channelId))].join(',');
            const channelRes = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelIds}&key=${apiKey}`);
            const channelData = await channelRes.json();
            const channelStats = {};
            channelData.items.forEach(c => channelStats[c.id] = c.statistics.subscriberCount);

            // ë°ì´í„° ê°€ê³µ
            currentData = videoData.items.map(v => {
                const views = parseInt(v.statistics.viewCount || 0);
                const subs = parseInt(channelStats[v.snippet.channelId] || 0);
                const likes = parseInt(v.statistics.likeCount || 0);
                const comments = parseInt(v.statistics.commentCount || 0);
                
                return {
                    id: v.id,
                    title: v.snippet.title,
                    channel: v.snippet.channelTitle,
                    thumb: v.snippet.thumbnails.maxres?.url || v.snippet.thumbnails.high.url,
                    date: v.snippet.publishedAt.substr(0,10),
                    subs: subs,
                    views: views,
                    duration: parseDuration(v.contentDetails.duration),
                    likes: likes,
                    comments: comments,
                    tags: v.snippet.tags || [],
                    // ë°˜ì‘ë„: (ì¡°íšŒìˆ˜/êµ¬ë…ì) ë¹„ìœ¨. êµ¬ë…ì 0ì´ë©´ ì¡°íšŒìˆ˜ ê·¸ëŒ€ë¡œ
                    score: subs > 0 ? (views/subs).toFixed(1) : 'N/A' 
                };
            });

            analyzeKeywords(currentData); // í‚¤ì›Œë“œ ë¶„ì„ ì‹¤í–‰
            renderTable();

        } catch (e) {
            alert('ì˜¤ë¥˜: ' + e.message);
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }

    // ğŸ”¥ í•µì‹¬ ê¸°ëŠ¥: í‚¤ì›Œë“œ ì¶”ì¶œ
    function analyzeKeywords(data) {
        const textPool = [];
        const stopWords = ['ì˜ìƒ', 'êµ¬ë…', 'ì¢‹ì•„ìš”', 'ì±„ë„', 'ì˜¤ëŠ˜', 'ì•ˆë…•í•˜ì„¸ìš”', 'shorts', 'youtube', 'tv', 'í‹°ë¹„', 'ë‰´ìŠ¤', 'ë°˜ì‘', 'ì¼ë³¸', 'ì¤‘êµ­', 'í•œêµ­', 'ë¯¸êµ­', 'í•´ì™¸', 'ì´ìœ ', 'í•˜ëŠ”', 'ìˆëŠ”', 'ì—†ëŠ”']; 

        data.forEach(item => {
            // ì œëª©ê³¼ íƒœê·¸ì—ì„œ ë‹¨ì–´ ìˆ˜ì§‘
            const words = item.title.split(/\s+|[\[\](){},.|!]/); // ê³µë°± ë° íŠ¹ìˆ˜ë¬¸ìë¡œ ë¶„ë¦¬
            textPool.push(...words);
            textPool.push(...item.tags);
        });

        const counts = {};
        textPool.forEach(word => {
            const cleanWord = word.replace(/[^ê°€-í£a-zA-Z0-9]/g, ''); // íŠ¹ìˆ˜ë¬¸ì ì œê±°
            if(cleanWord.length > 1 && !stopWords.includes(cleanWord.toLowerCase())) {
                counts[cleanWord] = (counts[cleanWord] || 0) + 1;
            }
        });

        // ë¹ˆë„ìˆœ ì •ë ¬
        topKeywords = Object.entries(counts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10)
            .map(entry => ({ word: entry[0], count: entry[1] }));

        // í™”ë©´ í‘œì‹œ
        const listArea = document.getElementById('keywordList');
        listArea.innerHTML = topKeywords.map(k => 
            `<div class="hot-keyword">${k.word} <span>${k.count}íšŒ</span></div>`
        ).join('');
        
        if(topKeywords.length > 0) {
            document.getElementById('keywordArea').style.display = 'block';
        }
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = currentData.map(item => `
            <tr>
                <td>
                    <img src="${item.thumb}" class="thumb-img"><br>
                    <a href="${item.thumb}" target="_blank" class="btn-thumb">ì¸ë„¤ì¼ ë°›ê¸°</a>
                </td>
                <td><a href="https://youtu.be/${item.id}" target="_blank" style="text-decoration:none; color:var(--text); font-weight:bold">${item.title}</a></td>
                <td>${item.channel}</td>
                <td>${item.date}</td>
                <td>${item.subs.toLocaleString()}</td>
                <td style="color:var(--primary); font-weight:bold">${item.views.toLocaleString()}</td>
                <td>${item.duration}</td>
                <td>${item.score}ë°°</td>
                <td>${item.tags.slice(0,5).map(t => `<span class="tag">#${t}</span>`).join('')}</td>
            </tr>
        `).join('');
    }

    function copyKeywords() {
        const text = topKeywords.map(k => k.word).join(', ');
        navigator.clipboard.writeText(text).then(() => alert('âœ… í‚¤ì›Œë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'));
    }

    function downloadCSV() {
        if(!currentData.length) return alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        let csv = '\uFEFFì œëª©,ì±„ë„,ë‚ ì§œ,êµ¬ë…ì,ì¡°íšŒìˆ˜,ì¢‹ì•„ìš”,ëŒ“ê¸€,ë°˜ì‘ë„,ì£¼ìš”í‚¤ì›Œë“œ\n';
        currentData.forEach(row => {
            csv += `"${row.title.replace(/"/g, '""')}","${row.channel}",${row.date},${row.subs},${row.views},${row.likes},${row.comments},${row.score},"${row.tags.join(' ')}"\n`;
        });
        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ìœ íŠœë¸Œë¶„ì„_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
    }

    function parseDuration(d) {
        const m = d.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
        const h = (m[1]||'').replace('H','');
        const min = (m[2]||'').replace('M','');
        const s = (m[3]||'').replace('S','');
        if(h) return `${h}:${min.padStart(2,'0')}:${s.padStart(2,'0')}`;
        return `${min}:${s.padStart(2,'0')}`;
    }

    function toggleTheme() {
        const b = document.body;
        b.getAttribute('data-theme') ? b.removeAttribute('data-theme') : b.setAttribute('data-theme', 'dark');
    }
</script>
</body>
</html>